<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stefan Schreiber">

<title>UPSTART: Universal Protocol for Silviculture TreAtment Research Trials</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="upstart_files/libs/clipboard/clipboard.min.js"></script>
<script src="upstart_files/libs/quarto-html/quarto.js"></script>
<script src="upstart_files/libs/quarto-html/popper.min.js"></script>
<script src="upstart_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="upstart_files/libs/quarto-html/anchor.min.js"></script>
<link href="upstart_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="upstart_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="upstart_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="upstart_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="upstart_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#disclaimer" id="toc-disclaimer" class="nav-link active" data-scroll-target="#disclaimer"><span class="header-section-number">1</span> Disclaimer</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">2</span> Introduction</a></li>
  <li><a href="#experimental-design" id="toc-experimental-design" class="nav-link" data-scroll-target="#experimental-design"><span class="header-section-number">3</span> Experimental design</a>
  <ul class="collapse">
  <li><a href="#randomization" id="toc-randomization" class="nav-link" data-scroll-target="#randomization"><span class="header-section-number">3.1</span> Randomization</a></li>
  <li><a href="#replication" id="toc-replication" class="nav-link" data-scroll-target="#replication"><span class="header-section-number">3.2</span> Replication</a></li>
  <li><a href="#sec-blocking" id="toc-sec-blocking" class="nav-link" data-scroll-target="#sec-blocking"><span class="header-section-number">3.3</span> Blocking</a></li>
  </ul></li>
  <li><a href="#sec-ex1" id="toc-sec-ex1" class="nav-link" data-scroll-target="#sec-ex1"><span class="header-section-number">4</span> Example 1: Estimate the effect of thinning on diameter growth in lodgepole pine stands</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">4.1</span> Overview</a></li>
  <li><a href="#randomized-complete-block-design" id="toc-randomized-complete-block-design" class="nav-link" data-scroll-target="#randomized-complete-block-design"><span class="header-section-number">4.2</span> Randomized Complete Block Design</a></li>
  </ul></li>
  <li><a href="#sec-ex2" id="toc-sec-ex2" class="nav-link" data-scroll-target="#sec-ex2"><span class="header-section-number">5</span> Example 2: Estimate the effect of site preparation and vegetation management on seedling survival in cutblock reforestation</a>
  <ul class="collapse">
  <li><a href="#overview-1" id="toc-overview-1" class="nav-link" data-scroll-target="#overview-1"><span class="header-section-number">5.1</span> Overview</a></li>
  <li><a href="#split-plot-design" id="toc-split-plot-design" class="nav-link" data-scroll-target="#split-plot-design"><span class="header-section-number">5.2</span> Split-plot design</a></li>
  </ul></li>
  <li><a href="#statistical-analyses" id="toc-statistical-analyses" class="nav-link" data-scroll-target="#statistical-analyses"><span class="header-section-number">6</span> Statistical analyses</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">UPSTART: Universal Protocol for Silviculture TreAtment Research Trials</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Stefan Schreiber </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<!-- ![](https://imgs.xkcd.com/comics/sphere_tastiness.png) -->
<section id="disclaimer" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="disclaimer"><span class="header-section-number">1</span> Disclaimer</h2>
<p>The following text represents a <strong><em>draft</em></strong> and is necessarily not complete. It requires input from various forestry practitioners to guide the authors of this text with more adequate examples pertaining to forestry. The purpose of this text is to provide a for further development and discussion.</p>
</section>
<section id="introduction" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="introduction"><span class="header-section-number">2</span> Introduction</h2>
<p>The objective of this work is to provide the members of the Forest Growth Organization of Western Canada (FGrOW) with guidelines for the design and implementation of silvicultural experiments. These experimental design considerations are adaptable to the given location and scalable to the needs of the individual member.</p>
<p>This document is split into three main sections:</p>
<ol type="1">
<li><p>Experimental designs for silvicultural experiments</p></li>
<li><p>A field manual supporting the implementation of the chosen design in the field</p></li>
<li><p>A data dictionary that explains all terminology</p></li>
</ol>
</section>
<section id="experimental-design" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="experimental-design"><span class="header-section-number">3</span> Experimental design</h2>
<p>In its most fundamental form, an experiment can be described as the intentional manipulation of input variables through defined treatments or interventions, resulting in a specific output or response. The objective of designed experiments is to understand cause-and-effect relationships between input and output variables using statistical models. The input variables are also referred to as <em>predictor</em> or <em>independent variables</em>, while the output variables are termed <em>response</em> or <em>dependent variables</em>. It is often helpful to draw a causal diagram to visualize this relationship. In <a href="#fig-dag1">Figure&nbsp;1</a> the causal relationship of <span class="math inline">X</span> on <span class="math inline">Y</span> is described. The black dots represent variables and the fact that variable <span class="math inline">X</span> causes variable <span class="math inline">Y</span> to change is indicated by the direction of the arrow. This also means that <span class="math inline">Y</span> cannot change the value of <span class="math inline">X</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dag1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="upstart_files/figure-html/fig-dag1-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1: The causal relationship of the predictor variable <span class="math inline">X</span> on the reponse variable <span class="math inline">Y</span></figcaption>
</figure>
</div>
</div>
</div>
<p>In reality, however, there are many other possible influences on our response and predictor variables <span class="math inline">Y</span> and <span class="math inline">X</span>. The most prominent one, and the one we seek to control in designed experiments, are unobserved influences caused by <span class="math inline">U</span>, such as landscape heterogeneity, environmental gradients or weather patterns in our study areas. <a href="#fig-dag2">Figure&nbsp;2</a> illustrates this. Before implementing experiments, it is highly recommended to understand what may cause a variable to change in our experimental setting. Causal diagrams are a great way to understand the interrelationships that influence the estimation of our response variable <span class="math inline">Y</span> and hence allowing us to account for them in the statistical model. Causal diagrams also ensure that assumptions are communicated before the experiment has started and conclusions are drawn.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dag2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="upstart_files/figure-html/fig-dag2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2: The causal relationship of the predictor variable <span class="math inline">X</span> on the reponse variable <span class="math inline">Y</span> as well as the effect of an unobserved variable <span class="math inline">U</span> on <span class="math inline">X</span> and <span class="math inline">Y</span></figcaption>
</figure>
</div>
</div>
</div>
<p>There are <strong><em>three key principles</em></strong> in the design of experiments:</p>
<ol type="1">
<li><p>Randomization</p></li>
<li><p>Replication</p></li>
<li><p>Blocking</p></li>
</ol>
<p>In the following sections, we will provide a brief summary of these design principles and then applying them to a more detailed hypothetical example.</p>
<section id="randomization" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="randomization"><span class="header-section-number">3.1</span> Randomization</h3>
<p>Randomization refers to the process of randomizing individuals into treatments as well as randomizing the order of the treatment application. For example, one could randomize seedlings into fertilizer treatments and the order of fertilizer treatments across study locations. The two major goals of randomization are to <strong><em>minimize systematic errors</em></strong> (bias) and to ensure <strong><em>independent observations</em></strong>, the latter being a key assumption for many statistical tests. Depending on the experiment, complete randomization might not always be feasible due to cost, time and space constraints. For most of those cases, however, there are experimental designs that can handle those situations and we will see examples later.</p>
</section>
<section id="replication" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="replication"><span class="header-section-number">3.2</span> Replication</h3>
<p>In order to quantify the experimental error associated for each treatment combination, one needs replicate measurements. This is important because the estimated experimental error, known as the <strong><em>standard error of the mean</em></strong>, plays a key role in statistical hypothesis testing. Another important reason why sufficient replication is required, is to gain <strong><em>precise estimates of the unknown population parameters</em></strong> from which the samples were drawn. The question as to how many replicates are sufficient depends on the research question and the design of the experiment. In general, however, aiming for 10 replicates in each treatment combination is a good start during the design stage of the experiment. Another consideration is much mortality is expected. When the experiment ends, one need to have enough samples left within each treatment group to infer meaningful results from the data. That being said, before the experiment is started, it is important to consult with a statistician or statistical expert to ensure the design is capable of informing the research questions. To quote Sir Ronald Fisher (1938)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>:</p>
<blockquote class="blockquote">
<p>To consult the statistician after an experiment is finished is often merely to ask him to conduct a post mortem examination. He can perhaps say what the experiment died of.</p>
</blockquote>
</section>
<section id="sec-blocking" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="sec-blocking"><span class="header-section-number">3.3</span> Blocking</h3>
<p>The primary reason for blocking is to reduce or eliminate unmeasured variability due to topography, moisture, aspect etc. These unmeasured variables are also known as nuisance factors. Blocking accomplishes this by breaking up larger heterogeneous experimental conditions into smaller relatively homogeneous experimental conditions in which the experimental treatments are replicated. This captures the unmeasured variability and increases the precision with which comparisons among the factors of interest are made. To be effective for statistical testing, it is suggested to have a minimum of six blocks within the experiment. This is needed in order to sufficiently quantify block to block variation.</p>
</section>
</section>
<section id="sec-ex1" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="sec-ex1"><span class="header-section-number">4</span> Example 1: Estimate the effect of thinning on diameter growth in lodgepole pine stands</h2>
<section id="overview" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">4.1</span> Overview</h3>
<p>Consider a scenario where we aim to understand the relationship between four thinning treatments (no thinning, 500, 1000, 2000 stems h<span class="math inline">^{-1}</span>) and their impact on diameter growth (DBH) in lodgepole pine stands.</p>
<p>The initial step involves identifying the <strong><em>specific area of interest</em></strong> to which one intends to extend the findings. If the focus is on a lodgepole pine stand near Edson, the experiment’s conclusions will be applicable solely to this particular lodgepole pine stand near Edson where the thinning treatment was applied. However, if the target is the Lower Foothills natural subregion, multiple treatment plots must be established within that subregion. In order for the study results to be as unbiased as possible, the location for the treatment plots should be chosen <strong><em>randomly</em></strong> rather than “conveniently”. Admittedly, achieving this assumption in large-scale forestry operations is not always straightforward. In such cases, any decision regarding why certain plots could not be chosen randomly has to be clearly documented.</p>
<p>At the study location level, one can generally assume that the chosen areas are not perfectly homogeneous with respect to the growing conditions, which can lead to bias in the estimates. Bias refers to systematic error introduced into sampling or testing by selecting or encouraging one outcome or a group of outcomes over others. This can lead to distorted or inaccurate results.</p>
<p>One way of controlling for such unwanted effects is by <strong><em>randomizing</em></strong> treatment plots across the area of interest. If the area is small, this may be sufficient. However, in most cases when studying silvicultural interventions, the required area is quite large and contains a great amount of variability (topography, moisture, aspect, etc.). In such cases, it is recommended to replicate the randomized thinning treatments into <strong><em>blocks</em></strong> across the larger area of interest (see <a href="#sec-blocking">Section&nbsp;3.3</a>).</p>
</section>
<section id="randomized-complete-block-design" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="randomized-complete-block-design"><span class="header-section-number">4.2</span> Randomized Complete Block Design</h3>
<p>Suppose a decision was made to estimate the effect of thinning in lodgepole pine stands in the Lower Foothills subregion. Ten target sites have been identified, adequately representing the site diversity in the Lower Foothills subregion. Due to observed variability within the sites, thinning treatments are replicated in six blocks. Each block consists of four thinning treatments: no thinning, 500, 1000, and 2000 stems h<span class="math inline">^{-1}</span>, applied to 500 m<span class="math inline">^2</span> plots. The order of the thinning treatment plots within the blocks is randomized. This experimental setup is commonly referred to as a randomized complete block design (RCBD).</p>
<p>In an RCBD:</p>
<p><strong>Blocks</strong>: The experimental units, in this case the 500 m<span class="math inline">^2</span> plots, are grouped into blocks based on some relevant characteristic that is expected to affect the response variable. For example, variations in soil type or other environmental factors and gradients. If gradients are present then the blocks should be oriented perpendicular to the gradient and not parallel. For example, if we are studying the effect of soil moisture on plant growth along a gradient of elevation, arranging the experimental blocks perpendicular to the elevation gradient would allow for better control and assessment of the variation in soil moisture levels across the gradient.</p>
<p><strong>Randomization</strong>: Within each block, treatments are randomly assigned to experimental units. Randomization helps to minimize the effects of confounding variables and ensures that any differences observed between treatments are likely due to the treatments themselves rather than other factors.</p>
<p><strong>Completeness</strong>: Each treatment is applied to every block, ensuring that every treatment is represented in each block. This allows for direct comparison of treatments within each block, reducing the impact of variation between blocks.</p>
<p>Overall, an RCBD is a flexible and efficient design that allows to control for sources of variation, such as environmental factors or other potential confounding variables, thereby improving the reliability and validity of their experimental results.</p>
</section>
</section>
<section id="sec-ex2" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="sec-ex2"><span class="header-section-number">5</span> Example 2: Estimate the effect of site preparation and vegetation management on seedling survival in cutblock reforestation</h2>
<section id="overview-1" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="overview-1"><span class="header-section-number">5.1</span> Overview</h3>
<p>Suppose the objective is to ascertain the impact of <em>site preparation</em> and <em>vegetation management</em>, as well as their potential interaction, on white spruce seedling survival in cutblocks within the central mixedwood natural subregion. Site preparation comprises three levels: control, ripping, and mounding, while vegetation management encompasses two levels: control and herbicide application.</p>
<p>Similar to the previous example, it is essential to select a representative number of randomly chosen sites to ensure generalizability across the broader area of interest. Subsequently, the experimental design needs to incorporate the two treatment factors, site preparation, and herbicide application.</p>
</section>
<section id="split-plot-design" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="split-plot-design"><span class="header-section-number">5.2</span> Split-plot design</h3>
<p>In a strictly randomized complete block design, all treatment level combinations are randomized within each block. However, in experiments involving treatments that require heavy machinery or larger-scale application, such as bulldozing for site preparation, implementing such treatments on a small scale might not be feasible. In such cases, a different design, known as the split-plot design, can be employed.</p>
<p>The main difference lies in the arrangement of treatment factors. The <strong>main plot</strong> encompasses the treatment applied on the larger scale, such as site preparation, while the second treatment factor, referred to as <strong>split plots</strong>, is superimposed onto the main plot. Since the main plot treatments are confounded with the main plots themselves (i.e., not randomized across the area of interest), while the split plots are not, ideally, the more significant treatment should be assigned to the split plots if possible.</p>
</section>
</section>
<section id="statistical-analyses" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="statistical-analyses"><span class="header-section-number">6</span> Statistical analyses</h2>
<p>In the analysis of randomized complete block designs, split-plot designs, and other experimental designs characterized by spatial or temporal correlation among experimental units, linear- and generalized linear mixed effects models (LMM, GLMM) are the preferred analytical tools. Mixed-effects models, also known as hierarchical or multilevel models, are adept at handling various issues such as imbalanced designs or spatial/temporal correlation.</p>
<p>While the fixed effects part of these models captures the effects of primary interest, i.e., the effects one seeks to estimate, the random effects part identifies the cluster structure within which replicates are grouped. This cluster structure accounts for the correlation among observations within the same cluster, offering a more accurate representation of the underlying data structure.</p>
<p>Consider the previous two examples, in (<a href="#sec-ex1">Section&nbsp;4</a>), <em>site</em> and <em>block</em> are the grouping variables that include trees that are likely to behave more similarly than trees from a different site-block combination. So the random effects term in this model would be <strong>site</strong> and <strong>block</strong> since each block-site combination requires its own error estimation. A model specified in this way would account for the potential spatial dependency of trees in this particular given design.</p>
<p>On the other hand, in (<a href="#sec-ex2">Section&nbsp;5</a>), we also have to consider the <em>main plot</em> since we can assume that split-plots in a given main plot will behave more similarly compared to split-plots in the other main plots. So in this example we would have <strong>site</strong> and <strong>block</strong> as well as <strong>main plot</strong>.</p>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>First Session of the Indian Statistical Conference, Calcutta, 1938<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>